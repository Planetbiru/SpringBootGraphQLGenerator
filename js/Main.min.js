let stringUtil=new StringUtil,generator=new GraphQLSpringGenerator,sqlParser=new SQLParser,util=new GraphQLSchemaUtils,entityRenderer,updatedWidth=600,drawRelationship=!0;function autopopulatePackage(e){let t=document.getElementById("groupId"),i=document.getElementById("artifactId"),n=document.getElementById("serviceName"),r=e.trim();if(!r){t.value="",i.value="",n.value="";return}t.value=r;let a=r.split("."),l=a[a.length-1];i.value=l,n.value=l.split(/[-_]/).map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")}function applyModel(e){let t=document.getElementById("maxRelationDepth"),i=Math.max(...e.entities.map(e=>e.depth))-1;t.value=i,generator.setModel(e)}let resizeTimeout;function createSelector(e,t){e.innerHTML="",t?.entities&&t.entities.forEach(t=>{let i=document.createElement("tr"),n=document.createElement("td"),r=document.createElement("td"),a=document.createElement("td"),l=document.createElement("input");l.setAttribute("type","checkbox"),l.setAttribute("checked","checked"),l.classList.add("selected-entity"),l.value=t.name,n.appendChild(l),r.innerHTML=t.name;let d="",o=t.columns.filter(e=>e.primaryKey);o&&(d=o.map(e=>e.name).join(", ")),a.innerHTML=d,i.appendChild(n),i.appendChild(r),i.appendChild(a),e.appendChild(i)})}function updateDbConfig(e){let{driver:t,dialect:i}=generator.getDriverAndDialect(e),n=document.getElementById("dbDriver"),r=document.getElementById("dbDialect");t&&i?(n.value=t,r.value=i,n.classList.remove("invalid"),r.classList.remove("invalid")):(n.value="",r.value="",n.classList.add("invalid"),r.classList.add("invalid"))}window.addEventListener("resize",()=>{clearTimeout(resizeTimeout),resizeTimeout=setTimeout(()=>{let e=document.querySelector(".erd-wrapper"),t=document.querySelector("#entity-selection-body");if(e){let i=e.clientWidth;i<480&&(i=480),entityRenderer.createERD(generator.getModel(),i,drawRelationship),entityRenderer.createDescription(generator.getModel(),"#erd-description"),createSelector(t,generator.getModel())}},30)}),document.addEventListener("DOMContentLoaded",()=>{let e=document.getElementById("configForm"),t=document.getElementById("packageName"),i=document.getElementById("dbUrl"),n=document.getElementById("sqlFile");(entityRenderer=new EntityRenderer(".erd-svg")).initIconEvent(generator);let r=document.querySelector(".erd-wrapper");r&&(updatedWidth=r.clientWidth),t.addEventListener("change",function(e){autopopulatePackage(e.target.value)}),t.addEventListener("keyup",function(e){autopopulatePackage(e.target.value)}),i.addEventListener("change",function(e){updateDbConfig(e.target.value)}),i.addEventListener("keyup",function(e){updateDbConfig(e.target.value)}),n.addEventListener("change",function(t){let i=new FormData(e),n=i.get("sqlFile");if(n){let r=document.querySelector("#entity-selection-body");generator.status("Import SQL file"),sqlParser.importSQLFile(n,e=>{e.entities=e.entities.filter(e=>"sqlite_sequence"!==e.name),applyModel(e),updatedWidth<480&&(updatedWidth=480),entityRenderer.createERD(e,updatedWidth,drawRelationship),entityRenderer.createDescription(e,"#erd-description"),createSelector(r,e),generator.status("Finish")})}});let a=document.querySelector(".check-all");a.checked=!0,a.addEventListener("change",function(){let e=document.querySelectorAll('#entity-selection-body input[type="checkbox"]'),t=this.checked;e.forEach(e=>{e.checked=t})});let l=new FormData(e),d=l.get("sqlFile");if(d){let o=document.querySelector("#entity-selection-body");generator.status("Import SQL file"),sqlParser.importSQLFile(d,e=>{e.entities=e.entities.filter(e=>"sqlite_sequence"!==e.name),applyModel(e),updatedWidth<480&&(updatedWidth=480),entityRenderer.createERD(e,updatedWidth,drawRelationship),entityRenderer.createDescription(e,"#erd-description"),createSelector(o,e),generator.status("Finish")})}e.addEventListener("submit",t=>{t.preventDefault();let i=new Date;generator.status("Get information given in the form");let n=new FormData(e),r={packageName:n.get("packageName"),groupId:n.get("groupId"),artifactId:n.get("artifactId"),serviceName:n.get("serviceName"),serviceDescription:n.get("serviceDescription"),javaVersion:n.get("javaVersion"),version:n.get("version"),maxRelationDepth:parseInt(n.get("maxRelationDepth"))||3,startTime:i},a={entities:[]},l=document.querySelectorAll('#entity-selection-body input[type="checkbox"]');if(l.length){let d=[];l.forEach(e=>{e.checked&&d.push(e.value)});let o=generator.getModel();generator.status("Apply selected entities"),o?.entities&&o.entities.forEach(e=>{d.includes(e.name)&&a.entities.push(e)})}generator.createZipFile(a,r,document.querySelector("#artifactId").value+".zip")});let c=document.getElementById("configForm"),s="formConfigData";function u(){let e=localStorage.getItem(s);if(!e)return;let t=JSON.parse(e);Object.keys(t).forEach(e=>{let i=c.querySelector(`[name="${e}"]`);i&&(i.value=t[e])})}function p(){let t={},i=e.querySelectorAll("input[type=text], input[type=number], select");i.forEach(e=>{t[e.name]=e.value}),localStorage.setItem(s,JSON.stringify(t))}c.addEventListener("input",p),c.addEventListener("change",p),u()});